<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>RandevularÄ±m</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Psikoterapi Randevu Sistemi</h1>
    <nav>
      <a href="index.html">Ana Sayfa</a>
      <a href="login.html" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ Yap</a>
    </nav>
  </header>

  <main>
    <h2>RandevularÄ±m</h2>
    <div id="appointmentsList">
      <p>Randevular yÃ¼kleniyor...</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 TÃ¼m HaklarÄ± SaklÄ±dÄ±r</p>
  </footer>

  <script>
    // EÄŸer localStorage'da user yoksa sahte kullanÄ±cÄ± ekle
if (!localStorage.getItem("user")) {
  localStorage.setItem("user", JSON.stringify({
    name: "Demo Psikolog",
    email: "demo@psiko.com",
    role: "psikolog", // ya da "danisan"
    age: 35,
    photo: "",
    specialty: ["Aile Terapisi", "Depresyon"],
    availableHours: ["10:00", "14:00"]
  }));
}

  document.addEventListener("DOMContentLoaded", () => {
    const user = JSON.parse(localStorage.getItem("user"));
    const appointmentsList = document.getElementById("appointmentsList");

    if (!user) {
      alert("LÃ¼tfen giriÅŸ yapÄ±nÄ±z.");
      window.location.href = "login.html";
      return;
    }

    const queryParam = user.role === "psikolog"
      ? `psikolog=${encodeURIComponent(user.email)}`
      : `email=${encodeURIComponent(user.email)}`;

    fetch(`http://localhost:3000/appointments?${queryParam}`)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          appointmentsList.innerHTML = "<p>HenÃ¼z randevunuz yok.</p>";
          return;
        }

        // Tarihlere gÃ¶re grupla
        const grouped = {};
        data.forEach(appt => {
          if (!grouped[appt.date]) grouped[appt.date] = [];
          grouped[appt.date].push(appt);
        });

        appointmentsList.innerHTML = "";

        Object.keys(grouped).sort().forEach(date => {
          const container = document.createElement("div");
          container.style.marginBottom = "20px";

          const title = document.createElement("h3");
          title.style.cursor = "pointer";
          title.textContent = `ğŸ“… ${date}`;
          title.addEventListener("click", () => {
            detailList.style.display = detailList.style.display === "none" ? "block" : "none";
          });

          const detailList = document.createElement("ul");
          detailList.style.display = "none";

          grouped[date].forEach(appt => {
            const li = document.createElement("li");
            const name = user.role === "psikolog" ? appt.client_name : appt.psikolog_name;

            li.innerHTML = `${appt.time} - ${name} <button data-id="${appt.id}">Sil</button>`;
            detailList.appendChild(li);
          });

          container.appendChild(title);
          container.appendChild(detailList);
          appointmentsList.appendChild(container);
        });

        // Silme
        document.querySelectorAll("button[data-id]").forEach(btn => {
          btn.addEventListener("click", () => {
            const confirmed = confirm("Bu randevuyu silmek istiyor musunuz?");
            if (!confirmed) return;

            const id = btn.getAttribute("data-id");

            fetch(`http://localhost:3000/appointments/${id}`, {
              method: "DELETE"
            })
              .then(res => res.json())
              .then(result => {
                alert(result.message);
                location.reload();
              })
              .catch(err => {
                console.error("Silme hatasÄ±:", err);
                alert("Randevu silinemedi.");
              });
          });
        });
      })
      .catch(err => {
        console.error("Randevu yÃ¼kleme hatasÄ±:", err);
        appointmentsList.innerHTML = "<p>Randevular yÃ¼klenirken bir hata oluÅŸtu.</p>";
      });

    // Ã‡Ä±kÄ±ÅŸ
    document.getElementById("logoutBtn").addEventListener("click", function (e) {
      e.preventDefault();
      localStorage.removeItem("user");
      window.location.href = "login.html";
    });
  });
</script>
</body>
</html>


